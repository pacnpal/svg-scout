const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min.js","assets/constants.js"])))=>i.map(i=>d[i]);
import{s as N,o as U}from"./browser-api.js";import{b as d,a as S}from"./constants.js";import{c as L}from"./storage.js";import{g}from"./svg-utils.js";const D="modulepreload",O=function(e){return"/"+e},h={},y=function(t,r,i){let c=Promise.resolve();if(r&&r.length>0){let a=function(s){return Promise.all(s.map(l=>Promise.resolve(l).then(w=>({status:"fulfilled",value:w}),w=>({status:"rejected",reason:w}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),f=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));c=a(r.map(s=>{if(s=O(s),s in h)return;h[s]=!0;const l=s.endsWith(".css"),w=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${w}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":D,l||(u.as="script"),u.crossOrigin="",u.href=s,f&&u.setAttribute("nonce",f),document.head.appendChild(u),l)return new Promise((E,_)=>{u.addEventListener("load",E),u.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${s}`)))})}))}function o(a){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a}return c.then(a=>{for(const n of a||[])n.status==="rejected"&&o(n.reason);return t().catch(o)})};let p=null,m=null;async function b(){p||(p=await y(()=>import("./jszip.min.js").then(e=>e.j),__vite__mapDeps([0,1])),m=await y(()=>import("./svg-to-png.js"),[]))}async function T(e,t){{const r=btoa(unescape(encodeURIComponent(e)));return`data:${t};base64,${r}`}}async function C(e,t,r){{if(await b(),!m)throw new Error("Failed to load PNG conversion module");const i=await m.svgToPng(e,{scale:t,backgroundColor:r});{const c=await i.arrayBuffer();return`data:image/png;base64,${btoa(String.fromCharCode(...new Uint8Array(c)))}`}}}async function $(e,t,r){{if(await b(),!p||!m)throw new Error("Failed to load ZIP/PNG modules");const i=p.default||p,c=new i,o=c.folder("svg"),a=t?c.folder("png"):null;for(let n=0;n<e.length;n++){const f=e[n],s=g(f,n).replace(".svg","");if(o.file(`${s}.svg`,f.content),t&&a&&r)try{const l=await m.svgToPng(f.content,{scale:r,backgroundColor:"transparent"});a.file(`${s}-${r}x.png`,l)}catch{}}return`data:application/zip;base64,${await c.generateAsync({type:"base64"})}`}}d.runtime.onInstalled.addListener(()=>{d.contextMenus.create({id:S.DOWNLOAD_SVG,title:"Download SVG",contexts:["image"],targetUrlPatterns:["*://*/*.svg","*://*/*.svg?*"]}),N()});d.runtime.onMessage.addListener((e,t)=>{if(e.target!=="offscreen")return A(e,t)});async function A(e,t){var r;switch(e.type){case"SCAN_RESULT":return await L(e.items,e.pageTitle),{success:!0};case"DOWNLOAD_SVG":return v(e.item,e.pageTitle);case"DOWNLOAD_PNG":return I(e.item,e.scale,e.backgroundColor,e.pageTitle,e.returnDataUrl);case"DOWNLOAD_ZIP":return x(e.items,e.includePng,e.pngScale,e.pageTitle,e.returnDataUrl);case"FETCH_EXTERNAL_SVG":return P(e.url);case"OPEN_SIDE_PANEL":return k(e.windowId??((r=t.tab)==null?void 0:r.windowId));case"COPY_SVG":return{success:!0};default:return{success:!1,error:"Unknown message type"}}}async function v(e,t){try{const r=await T(e.content,"image/svg+xml"),i=g(e,0,t);return await d.downloads.download({url:r,filename:i}),{success:!0}}catch(r){return{success:!1,error:String(r)}}}async function I(e,t,r,i,c){try{const o=await C(e.content,t,r),n=`${g(e,0,i).replace(".svg","")}-${t}x.png`;return c?{success:!0,dataUrl:o,filename:n}:(await d.downloads.download({url:o,filename:n}),{success:!0})}catch(o){return{success:!1,error:String(o)}}}async function x(e,t,r,i,c){try{const o=await $(e,t,r),a=i?`${G(i)}-svgs.zip`:"svg-export.zip";return c?{success:!0,dataUrl:o,filename:a}:(await d.downloads.download({url:o,filename:a}),{success:!0})}catch(o){return{success:!1,error:String(o)}}}function G(e){return e.replace(/[<>:"/\\|?*]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").substring(0,50).toLowerCase()}async function P(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}`);return{success:!0,data:await t.text()}}catch(t){return{success:!1,error:String(t)}}}async function k(e){try{return await U(e),{success:!0}}catch(t){return{success:!1,error:String(t)}}}d.contextMenus.onClicked.addListener(async e=>{if(e.menuItemId===S.DOWNLOAD_SVG&&e.srcUrl)try{const t=await P(e.srcUrl);if(t.success&&t.data){const r={id:"context-menu-download",content:t.data,source:"img",sourceUrl:e.srcUrl,dimensions:{width:0,height:0},fileSize:t.data.length};await v(r)}}catch(t){console.error("Failed to download SVG:",t)}});
