import"./modulepreload-polyfill.js";import{i as W}from"./browser-api.js";import{g as M,s as _}from"./storage.js";import{b as i}from"./constants.js";const h=document.getElementById("scanBtn"),v=document.getElementById("sidePanelBtn"),C=document.getElementById("formatRow"),U=document.getElementById("formatSelect"),A=document.getElementById("downloadActions"),f=document.getElementById("downloadSelectedBtn"),y=document.getElementById("downloadSelectedText"),E=document.getElementById("downloadAllBtn"),w=document.getElementById("selectAllCheckbox"),D=document.getElementById("status"),G=D.querySelector(".status-text"),I=document.getElementById("results"),O=document.getElementById("resultsCount"),b=document.getElementById("resultsGrid"),B=document.querySelector(".footer-text"),R=document.getElementById("themeToggle");let d=[],c=new Set,g="system",p;function F(){const e=U.value;return e==="svg"?{type:"svg"}:{type:"png",scale:parseInt(e.replace("png-","").replace("x",""))}}async function j(){g=(await M()).theme,P(g),h.addEventListener("click",k),v.addEventListener("click",X),f.addEventListener("click",Y),E.addEventListener("click",ee),w.addEventListener("change",Q),R.addEventListener("click",q),i.runtime.onMessage.addListener(t=>H(t)),await k()}function P(e){if(document.documentElement.setAttribute("data-theme-preference",e),e==="system"){const t=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",t?"dark":"light")}else document.documentElement.setAttribute("data-theme",e)}async function q(){const e=["system","light","dark"],t=e.indexOf(g);g=e[(t+1)%e.length],P(g),await _({theme:g})}async function k(){var e,t,o,n,s,a,m;h.disabled=!0,h.classList.add("scanning"),u("scanning","Scanning page...");try{const[r]=await i.tabs.query({active:!0,currentWindow:!0});if(!r.id)throw new Error("No active tab");if((e=r.url)!=null&&e.startsWith("chrome://")||(t=r.url)!=null&&t.startsWith("chrome-extension://")||(o=r.url)!=null&&o.startsWith("about:")||(n=r.url)!=null&&n.startsWith("edge://")||(s=r.url)!=null&&s.startsWith("moz-extension://")||(a=r.url)!=null&&a.startsWith("safari-extension://")||(m=r.url)!=null&&m.startsWith("safari-web-extension://"))throw new Error("Cannot scan browser pages");let l=await z(r.id,{type:"SCAN_PAGE"});if(l||(await V(r.id),await new Promise($=>setTimeout($,100)),l=await Z(r.id,{type:"SCAN_PAGE"},3)),l.success&&l.data)p=l.pageTitle,N(l.data);else throw new Error(l.error||"Scan failed")}catch(r){console.error("Scan error:",r);const l=String(r);l.includes("Cannot scan browser pages")?u("error","Cannot scan this page type"):l.includes("Could not establish connection")||l.includes("Receiving end does not exist")?u("error","Please refresh the page and try again"):u("error",`Error: ${r}`)}finally{h.disabled=!1,h.classList.remove("scanning")}}async function z(e,t){try{return await i.tabs.sendMessage(e,t)}catch{return null}}async function V(e){var t;try{const o=await i.scripting.executeScript({target:{tabId:e},func:()=>!!window.__svgScoutInjected});if((t=o==null?void 0:o[0])!=null&&t.result)return;await i.scripting.executeScript({target:{tabId:e},func:()=>{window.__svgScoutInjected=!0}}),await i.scripting.executeScript({target:{tabId:e},files:["assets/index.ts.js"]})}catch(o){throw console.error("Failed to inject content script:",o),o}}async function Z(e,t,o){let n=null;for(let s=0;s<o;s++)try{return await i.tabs.sendMessage(e,t)}catch(a){if(n=a,(String(a).includes("Could not establish connection")||String(a).includes("Receiving end does not exist"))&&s<o-1)await new Promise(r=>setTimeout(r,200*Math.pow(2,s)));else throw a}throw n}function H(e){if(e.type==="SCAN_PROGRESS"){const{progress:t}=e;u("scanning",`${t.phase}: ${t.found} found`)}else if(e.type==="SCAN_RESULT"){const{items:t}=e;N(t)}}function N(e){if(d=e,c.clear(),e.length===0){u("complete","No SVGs found on this page"),I.style.display="none",v.style.display="none",C.style.display="none",A.style.display="none",B.textContent="Try a different page";return}u("complete","Scan complete"),I.style.display="flex",v.style.display="none",C.style.display="flex",A.style.display="flex",O.textContent=`${e.length} SVG${e.length===1?"":"s"} found`,L(),x(),B.textContent="Click to select, then download"}function L(){b.replaceChildren();for(const e of d){const t=document.createElement("div");t.className=`svg-item ${c.has(e.id)?"selected":""}`,t.dataset.id=e.id;const o=document.createElement("div");o.className="check-overlay";const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("viewBox","0 0 24 24"),n.setAttribute("fill","none"),n.setAttribute("stroke","currentColor");const s=document.createElementNS("http://www.w3.org/2000/svg","polyline");s.setAttribute("points","20 6 9 17 4 12"),n.appendChild(s),o.appendChild(n);const a=document.createElement("div");a.className="svg-preview",a.appendChild(J(e.content)),t.appendChild(o),t.appendChild(a),t.addEventListener("click",()=>K(e.id)),b.appendChild(t)}}function J(e){const n=new DOMParser().parseFromString(e,"image/svg+xml").documentElement;if(n.removeAttribute("onload"),n.removeAttribute("onerror"),!n.hasAttribute("viewBox")){const s=n.getAttribute("width"),a=n.getAttribute("height");if(s&&a){const m=parseFloat(s)||24,r=parseFloat(a)||24;n.setAttribute("viewBox",`0 0 ${m} ${r}`)}else n.setAttribute("viewBox","0 0 24 24")}return n.removeAttribute("width"),n.removeAttribute("height"),n.style.width="100%",n.style.height="100%",n}function K(e){c.has(e)?c.delete(e):c.add(e),x();const t=b.querySelector(`[data-id="${e}"]`);t&&t.classList.toggle("selected",c.has(e))}function Q(){w.checked?d.forEach(e=>c.add(e.id)):c.clear(),x(),L()}function x(){const e=c.size;f.disabled=e===0,e===0?y.textContent="Download Selected":e===1?y.textContent="Download (1)":y.textContent=`Download (${e})`,w.checked=e===d.length&&e>0,w.indeterminate=e>0&&e<d.length}function u(e,t){D.className=`status ${e}`,G.textContent=t}async function X(){{const[e]=await i.tabs.query({active:!0,currentWindow:!0});e!=null&&e.windowId&&await i.runtime.sendMessage({type:"OPEN_SIDE_PANEL",windowId:e.windowId})}window.close()}async function Y(){console.log("handleDownloadSelected called, selected:",c.size);const e=d.filter(t=>c.has(t.id));if(e.length===0){console.log("No items selected");return}console.log("Downloading",e.length,"items"),f.disabled=!0;try{await T(e),console.log("downloadItems completed")}catch(t){console.error("Download error:",t)}finally{f.disabled=!1}}async function ee(){if(d.length!==0){E.disabled=!0;try{await T(d)}catch(e){console.error("Download error:",e)}finally{E.disabled=!1}}}function S(e,t){return new Promise(o=>{console.log("Safari download attempt:",t,e.substring(0,50));const n=document.createElement("a");n.href=e,n.download=t,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),console.log("Anchor click executed"),e.startsWith("data:image/svg+xml")&&setTimeout(()=>{window.location.href=e},100),o()})}function te(e,t,o){if(e.sourceUrl){const s=e.sourceUrl.split("/"),a=s[s.length-1].split("?")[0];if(a&&a.includes("."))return a.replace(/\.[^.]+$/,".svg")}return`${o?o.toLowerCase().replace(/[^a-z0-9]+/g,"-").substring(0,20):"icon"}-${t+1}.svg`}async function T(e){const t=F();console.log("downloadItems called, isSafari:",W,"format:",t.type,"items:",e.length);{if(console.log("Using Safari download path"),e.length===1){const o=e[0],n=te(o,0,p);if(console.log("Single item download:",n),t.type==="svg"){const s="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(o.content)));console.log("SVG data URL created, length:",s.length),S(s,n)}else{const s=await i.runtime.sendMessage({type:"DOWNLOAD_PNG",item:o,scale:t.scale,pageTitle:p,returnDataUrl:!0});s.success&&s.dataUrl&&s.filename&&S(s.dataUrl,s.filename)}}else{const o=await i.runtime.sendMessage({type:"DOWNLOAD_ZIP",items:e,includePng:t.type==="png",pngScale:t.type==="png"?t.scale:void 0,pageTitle:p,returnDataUrl:!0});o.success&&o.dataUrl&&o.filename&&S(o.dataUrl,o.filename)}return}}j();
