import{b as h,S as A,C as V}from"./constants.js";import{c as l,i as p,d as y,a as g,b as N}from"./svg-utils.js";function R(){const e=[],t=document.querySelectorAll("svg");for(const n of t){if(_(n))continue;const o=M(n),s=l(o,"inline");s&&e.push(s)}return e}function _(e){if(e.querySelector("symbol")){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.width==="0px"&&t.height==="0px"||e.getAttribute("aria-hidden")==="true")return!0}return!1}function M(e){const t=e.cloneNode(!0);return z(e,t),new XMLSerializer().serializeToString(t)}function z(e,t){const n=window.getComputedStyle(e),o=["fill","stroke","stroke-width","stroke-linecap","stroke-linejoin","stroke-dasharray","stroke-dashoffset","opacity","fill-opacity","stroke-opacity","transform","font-family","font-size","font-weight","text-anchor"];for(const i of o){const c=n.getPropertyValue(i);c&&c!=="none"&&c!=="normal"&&t.style.setProperty(i,c)}const s=e.children,r=t.children;for(let i=0;i<s.length;i++)r[i]&&z(s[i],r[i])}async function U(){const e=[],t=document.querySelectorAll("img");for(const n of t){const o=n.src||n.getAttribute("src")||"";if(p(o)){const r=y(o);if(r){const i=l(r,"img",o);i&&e.push(i)}}else if(g(o))try{const r=await x(o);if(r){const i=l(r,"img",o);i&&e.push(i)}}catch{}const s=n.srcset||n.getAttribute("srcset")||"";if(s){const r=q(s);for(const i of r)if(g(i))try{const c=await x(i);if(c){const a=l(c,"img",i);a&&e.push(a)}}catch{}}}return e}async function x(e){try{const t=await fetch(e);if(t.ok)return await t.text()}catch{try{const t=await h.runtime.sendMessage({type:"FETCH_EXTERNAL_SVG",url:e});if(t.success&&t.data)return t.data}catch{}}return null}function q(e){return e.split(",").map(t=>t.trim().split(/\s+/)[0]).filter(Boolean)}async function G(){const e=[],t=document.querySelectorAll("object");for(const o of t){const s=o.type||o.getAttribute("type")||"",r=o.data||o.getAttribute("data")||"";if(A.includes(s)||g(r))try{const i=await k(r);if(i){const c=l(i,"object-embed",r);c&&e.push(c)}}catch{}}const n=document.querySelectorAll("embed");for(const o of n){const s=o.type||o.getAttribute("type")||"",r=o.src||o.getAttribute("src")||"";if(A.includes(s)||g(r))try{const i=await k(r);if(i){const c=l(i,"object-embed",r);c&&e.push(c)}}catch{}}return e}async function k(e){if(!e)return null;try{const t=await fetch(e);if(t.ok)return await t.text()}catch{try{const t=await h.runtime.sendMessage({type:"FETCH_EXTERNAL_SVG",url:e});if(t.success&&t.data)return t.data}catch{}}return null}async function I(){const e=[],t=new Set,n=document.querySelectorAll("*");for(const o of n){const s=window.getComputedStyle(o),r=window.getComputedStyle(o,"::before"),i=window.getComputedStyle(o,"::after");for(const c of V){const a=s.getPropertyValue(c);await w(a,e,t);const f=r.getPropertyValue(c);await w(f,e,t);const u=i.getPropertyValue(c);await w(u,e,t)}}return e}async function w(e,t,n){if(!e||e==="none")return;const o=e.matchAll(/url\((?:"([^"]+)"|'([^']+)'|([^)]+))\)/g);for(const s of o){const r=s[1]||s[2]||s[3];if(r&&!n.has(r)){if(n.add(r),p(r)){const i=y(r);if(i){const c=l(i,"css-background",r);c&&t.push(c)}}else if(g(r))try{const i=await $(r);if(i){const c=l(i,"css-background",r);c&&t.push(c)}}catch{}}}}async function $(e){try{const t=new URL(e,window.location.href).href,n=await fetch(t);if(n.ok&&((n.headers.get("content-type")||"").includes("svg")||t.endsWith(".svg")))return await n.text()}catch{try{const t=new URL(e,window.location.href).href,n=await h.runtime.sendMessage({type:"FETCH_EXTERNAL_SVG",url:t});if(n.success&&n.data)return n.data}catch{}}return null}async function W(){const e=[],t=document.querySelectorAll("use[href], use[xlink\\:href]");for(const o of t){const s=o.getAttribute("href")||o.getAttribute("xlink:href")||"";if(s)try{const r=await j(o,s);if(r){const i=l(r,"sprite",s);i&&e.push(i)}}catch{}}const n=document.querySelectorAll('svg[aria-hidden="true"] symbol, svg[style*="display: none"] symbol, svg[style*="display:none"] symbol');for(const o of n){const s=E(o);if(s){const r=o.id||"",i=l(s,"sprite",`#${r}`);i&&e.push(i)}}return e}async function j(e,t){if(t.includes(".svg")&&!t.startsWith("#")){const[s,r]=t.split("#"),i=await X(s);return i?r?F(i,r):i:null}const n=t.startsWith("#")?t.slice(1):t,o=document.getElementById(n);return o?o.tagName.toLowerCase()==="symbol"?E(o):o.tagName.toLowerCase()==="svg"?new XMLSerializer().serializeToString(o):null:null}function E(e){const t=e.getAttribute("viewBox")||"",n=document.createElementNS("http://www.w3.org/2000/svg","svg");if(n.setAttribute("xmlns","http://www.w3.org/2000/svg"),t){n.setAttribute("viewBox",t);const[,,s,r]=t.split(/\s+|,/).map(Number);s&&n.setAttribute("width",String(s)),r&&n.setAttribute("height",String(r))}for(const s of e.childNodes)n.appendChild(s.cloneNode(!0));for(const s of e.attributes)s.name!=="id"&&!n.hasAttribute(s.name)&&n.setAttribute(s.name,s.value);return new XMLSerializer().serializeToString(n)}function F(e,t){const s=new DOMParser().parseFromString(e,"image/svg+xml").getElementById(t);return s&&s.tagName.toLowerCase()==="symbol"?E(s):null}async function X(e){try{const t=new URL(e,window.location.href).href,n=await fetch(t);if(n.ok)return await n.text()}catch{try{const t=new URL(e,window.location.href).href,n=await h.runtime.sendMessage({type:"FETCH_EXTERNAL_SVG",url:t});if(n.success&&n.data)return n.data}catch{}}return null}function B(){const e=[];return S(document.body,e),e}function S(e,t){const n=e.querySelectorAll("*");for(const o of n){o.shadowRoot&&(v(o.shadowRoot,t),S(o.shadowRoot,t));try{const s=o.__shadowRoot;s&&(v(s,t),S(s,t))}catch{}try{const s=o.openOrClosedShadowRoot;s&&s!==o.shadowRoot&&(v(s,t),S(s,t))}catch{}}}function v(e,t){const n=e.querySelectorAll("svg");for(const o of n){if(O(o))continue;const s=H(o),r=l(s,"shadow-dom");r&&t.push(r)}}function O(e){if(e.querySelector("symbol")){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.width==="0px"&&t.height==="0px"||e.getAttribute("aria-hidden")==="true")return!0}return!1}function H(e){const t=e.cloneNode(!0);return L(e,t),new XMLSerializer().serializeToString(t)}function L(e,t){const n=window.getComputedStyle(e),o=["fill","stroke","stroke-width","stroke-linecap","stroke-linejoin","stroke-dasharray","stroke-dashoffset","opacity","fill-opacity","stroke-opacity","transform","font-family","font-size","font-weight","text-anchor"];for(const i of o){const c=n.getPropertyValue(i);c&&c!=="none"&&c!=="normal"&&t.style.setProperty(i,c)}const s=e.children,r=t.children;for(let i=0;i<s.length;i++)r[i]&&L(s[i],r[i])}async function D(){const e=[],t=document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"], link[rel="apple-touch-icon"]');for(const n of t){const o=n.getAttribute("href")||"",s=n.getAttribute("type")||"",r=A.includes(s);if(p(o)){const i=y(o);if(i){const c=l(i,"favicon",o);c&&e.push(c)}}else if(r||g(o))try{const i=await P(o);if(i){const c=l(i,"favicon",o);c&&e.push(c)}}catch{}}return e}async function P(e){if(!e)return null;try{const t=new URL(e,window.location.href).href,n=await fetch(t);if(n.ok)return await n.text()}catch{try{const t=new URL(e,window.location.href).href,n=await h.runtime.sendMessage({type:"FETCH_EXTERNAL_SVG",url:t});if(n.success&&n.data)return n.data}catch{}}return null}function J(){const e=[],t=document.querySelectorAll("template");for(const n of t){const o=n.content,s=o.querySelectorAll("svg");for(const c of s){const f=new XMLSerializer().serializeToString(c),u=l(f,"template");u&&e.push(u)}const r=o.querySelectorAll("img");for(const c of r){const a=c.getAttribute("src")||"";if(p(a)){const f=y(a);if(f){const u=l(f,"template",a);u&&e.push(u)}}else g(a)}const i=o.querySelectorAll("use[href], use[xlink\\:href]");for(const c of i){const a=c.getAttribute("href")||c.getAttribute("xlink:href")||"";if(a.startsWith("#")){const f=a.slice(1),u=o.getElementById(f);if(u&&u.tagName.toLowerCase()==="symbol"){const m=Y(u);if(m){const d=l(m,"template",a);d&&e.push(d)}}}}}return e}function Y(e){const t=e.getAttribute("viewBox")||"",n=document.createElementNS("http://www.w3.org/2000/svg","svg");if(n.setAttribute("xmlns","http://www.w3.org/2000/svg"),t){n.setAttribute("viewBox",t);const s=t.split(/\s+|,/).map(Number);s.length===4&&(s[2]&&n.setAttribute("width",String(s[2])),s[3]&&n.setAttribute("height",String(s[3])))}for(const s of e.childNodes)n.appendChild(s.cloneNode(!0));for(const s of e.attributes)s.name!=="id"&&!n.hasAttribute(s.name)&&n.setAttribute(s.name,s.value);return new XMLSerializer().serializeToString(n)}function K(){const e=[],t=new Set,n=document.querySelectorAll("*");for(const o of n){const s=o.attributes;for(const r of s){if(!r.name.startsWith("data-"))continue;const i=r.value.trim();if(i&&!t.has(i)){if(Q(i)){t.add(i);const c=l(i,"data-attribute",`${r.name} attribute`);c&&e.push(c);continue}if(p(i)){t.add(i);const c=y(i);if(c){const a=l(c,"data-attribute",`${r.name} attribute`);a&&e.push(a)}}}}}return e}function Q(e){const t=e.trim();return!(!t.startsWith("<svg")&&!t.startsWith("<?xml")||!t.includes("</svg>")&&!t.includes("/>"))}async function Z(){const e=[],t=document.querySelectorAll("noscript");for(const n of t){const o=n.innerHTML||n.textContent||"";if(!o.trim())continue;const r=new DOMParser().parseFromString(`<body>${o}</body>`,"text/html"),i=r.querySelectorAll("svg");for(const f of i){const m=new XMLSerializer().serializeToString(f),d=l(m,"noscript");d&&e.push(d)}const c=r.querySelectorAll("img");for(const f of c){const u=f.getAttribute("src")||"";if(p(u)){const m=y(u);if(m){const d=l(m,"noscript",u);d&&e.push(d)}}else if(g(u))try{const m=await T(u);if(m){const d=l(m,"noscript",u);d&&e.push(d)}}catch{}}const a=r.querySelectorAll('object[data$=".svg"], embed[src$=".svg"]');for(const f of a){const u=f.getAttribute("data")||f.getAttribute("src")||"";if(g(u))try{const m=await T(u);if(m){const d=l(m,"noscript",u);d&&e.push(d)}}catch{}}}return e}async function T(e){try{const t=new URL(e,window.location.href).href,n=await fetch(t);if(n.ok&&((n.headers.get("content-type")||"").includes("svg")||t.endsWith(".svg")))return await n.text()}catch{try{const t=new URL(e,window.location.href).href,n=await h.runtime.sendMessage({type:"FETCH_EXTERNAL_SVG",url:t});if(n.success&&n.data)return n.data}catch{}}return null}function tt(){const e=[],t=new Set,n=document.querySelectorAll('script[type="application/json"], script[type="application/ld+json"]');for(const o of n){const s=o.textContent||"";if(s.trim())try{const r=JSON.parse(s),i=C(r);for(const c of i)if(!t.has(c)){if(t.add(c),p(c)){const a=y(c);if(a){const f=l(a,"json-script");f&&e.push(f)}}else if(nt(c)){const a=l(c,"json-script");a&&e.push(a)}}}catch{}}return e}function C(e,t=[]){if(e==null)return t;if(typeof e=="string")return et(e)&&t.push(e),t;if(Array.isArray(e)){for(const n of e)C(n,t);return t}if(typeof e=="object")for(const n of Object.values(e))C(n,t);return t}function et(e){const t=e.trim();return!!(t.startsWith("data:image/svg+xml")||(t.startsWith("<svg")||t.startsWith("<?xml"))&&(t.includes("</svg>")||t.includes("/>")))}function nt(e){const t=e.trim();return!(!t.startsWith("<svg")&&!t.startsWith("<?xml")||!t.includes("</svg>")&&!t.includes("/>"))}const b=[{name:"Inline SVGs",detect:R},{name:"Image SVGs",detect:U},{name:"Object/Embed SVGs",detect:G},{name:"CSS Background SVGs",detect:I},{name:"Sprite SVGs",detect:W},{name:"Shadow DOM SVGs",detect:B},{name:"Favicon SVGs",detect:D},{name:"Template SVGs",detect:J},{name:"Data Attribute SVGs",detect:K},{name:"Noscript SVGs",detect:Z},{name:"JSON Script SVGs",detect:tt}];async function st(e){const t=[];for(let o=0;o<b.length;o++){const s=b[o];e==null||e({phase:s.name,found:t.length,total:b.length});try{const r=await s.detect();t.push(...r)}catch(r){console.warn(`SVG Scout: ${s.name} failed:`,r)}}const n=N(t);return e==null||e({phase:"Complete",found:n.length}),n}window.__svgScoutInjected=!0;h.runtime.onMessage.addListener(e=>ot(e));async function ot(e){switch(e.type){case"SCAN_PAGE":return it();default:return{success:!1,error:"Unknown message type"}}}async function it(){try{const e=await st(n=>{h.runtime.sendMessage({type:"SCAN_PROGRESS",progress:n})}),t=document.title||void 0;return h.runtime.sendMessage({type:"SCAN_RESULT",items:e,pageTitle:t}),{success:!0,data:e,pageTitle:t}}catch(e){return{success:!1,error:String(e)}}}
