import"./modulepreload-polyfill.js";import{b as l}from"./constants.js";import{g as F,a as W,b as R,s as $}from"./storage.js";import{g as L}from"./svg-utils.js";let m="system";const x=document.getElementById("scanBtn"),M=document.getElementById("filterSelect"),D=document.getElementById("sortSelect"),P=document.getElementById("gridViewBtn"),V=document.getElementById("listViewBtn"),T=document.getElementById("statusBar"),p=document.getElementById("statusText"),k=document.getElementById("emptyState"),y=document.getElementById("svgGrid"),S=document.getElementById("selectAllCheckbox"),j=document.getElementById("selectedCount"),U=document.getElementById("formatSelect"),G=document.getElementById("downloadSelectedBtn"),b=document.getElementById("downloadAllBtn"),Z=document.getElementById("themeToggle");let c=[],r=[],d=new Set,v="grid",g;function O(){const e=U.value;return e==="svg"?{type:"svg"}:{type:"png",scale:parseInt(e.replace("png-","").replace("x",""))}}async function q(){const e=await F();v=e.viewMode,m=e.theme,B(m),z();const t=await W();g=await R(),t&&t.length>0&&(c=t,h(),p.textContent=`Found ${c.length} SVG${c.length===1?"":"s"}`),x.addEventListener("click",X),M.addEventListener("change",h),D.addEventListener("change",h),P.addEventListener("click",()=>N("grid")),V.addEventListener("click",()=>N("list")),S.addEventListener("change",te),G.addEventListener("click",ie),b.addEventListener("click",ae),Z.addEventListener("click",K),l.runtime.onMessage.addListener(n=>Y(n)),l.storage.onChanged.addListener((n,s)=>{if(s==="local"&&n.lastScanResults){const i=n.lastScanResults.newValue;i&&i.length>0&&(c=i,d.clear(),h(),p.textContent=`Found ${c.length} SVG${c.length===1?"":"s"}`)}if(s==="local"&&n.lastPageTitle&&(g=n.lastPageTitle.newValue),s==="local"&&n.settings){const i=n.settings.newValue;i!=null&&i.theme&&i.theme!==m&&(m=i.theme,B(m))}})}function B(e){if(document.documentElement.setAttribute("data-theme-preference",e),e==="system"){const t=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",t?"dark":"light")}else document.documentElement.setAttribute("data-theme",e)}async function K(){const e=["system","light","dark"],t=e.indexOf(m);m=e[(t+1)%e.length],B(m),await $({theme:m})}async function X(){var e,t,n,s,i;x.disabled=!0,T.classList.add("scanning"),p.textContent="Scanning page...";try{const[a]=await l.tabs.query({active:!0,currentWindow:!0});if(!a.id)throw new Error("No active tab");if((e=a.url)!=null&&e.startsWith("chrome://")||(t=a.url)!=null&&t.startsWith("chrome-extension://")||(n=a.url)!=null&&n.startsWith("about:")||(s=a.url)!=null&&s.startsWith("edge://")||(i=a.url)!=null&&i.startsWith("moz-extension://"))throw new Error("Cannot scan browser pages");let o=await H(a.id,{type:"SCAN_PAGE"});if(o||(await J(a.id),await new Promise(u=>setTimeout(u,100)),o=await Q(a.id,{type:"SCAN_PAGE"},3)),o.success&&o.data)c=o.data,g=o.pageTitle,h(),p.textContent=`Found ${c.length} SVG${c.length===1?"":"s"}`;else throw new Error(o.error||"Scan failed")}catch(a){const o=String(a);o.includes("Cannot scan browser pages")?p.textContent="Cannot scan this page type":o.includes("Could not establish connection")||o.includes("Receiving end does not exist")?p.textContent="Please refresh the page and try again":p.textContent=`Error: ${a}`}finally{x.disabled=!1,T.classList.remove("scanning")}}async function H(e,t){try{return await l.tabs.sendMessage(e,t)}catch{return null}}async function J(e){var t;try{const n=await l.scripting.executeScript({target:{tabId:e},func:()=>!!window.__svgScoutInjected});if((t=n==null?void 0:n[0])!=null&&t.result)return;await l.scripting.executeScript({target:{tabId:e},func:()=>{window.__svgScoutInjected=!0}}),await l.scripting.executeScript({target:{tabId:e},files:["assets/index.ts.js"]})}catch(n){throw console.error("Failed to inject content script:",n),n}}async function Q(e,t,n){let s=null;for(let i=0;i<n;i++)try{return await l.tabs.sendMessage(e,t)}catch(a){if(s=a,(String(a).includes("Could not establish connection")||String(a).includes("Receiving end does not exist"))&&i<n-1)await new Promise(u=>setTimeout(u,200*Math.pow(2,i)));else throw a}throw s}function Y(e){if(e.type==="SCAN_PROGRESS"){const{progress:t}=e;p.textContent=`${t.phase}: ${t.found} found`}else if(e.type==="SCAN_RESULT"){const{items:t,pageTitle:n}=e;t&&t.length>0&&(c=t,g=n,d.clear(),h(),p.textContent=`Found ${c.length} SVG${c.length===1?"":"s"}`)}}function h(){const e=M.value,t=D.value;switch(r=e==="all"?[...c]:c.filter(n=>n.source===e),t){case"size-asc":r.sort((n,s)=>n.fileSize-s.fileSize);break;case"size-desc":r.sort((n,s)=>s.fileSize-n.fileSize);break;case"name":r.sort((n,s)=>{const i=L(n,0),a=L(s,0);return i.localeCompare(a)});break}E(),A()}function E(){if(r.length===0){k.style.display="flex",y.style.display="none",b.disabled=!0;return}k.style.display="none",y.style.display="grid",y.className=`svg-grid ${v==="list"?"list-view":""}`,b.disabled=!1,y.replaceChildren();for(const e of r){const t=document.createElement("div");t.className=`svg-item ${d.has(e.id)?"selected":""}`,t.dataset.id=e.id;const n=document.createElement("div");n.className="svg-preview";const s=document.createElement("input");s.type="checkbox",s.className="svg-checkbox",s.checked=d.has(e.id),n.appendChild(s),n.appendChild(ee(e.content));const i=document.createElement("div");i.className="svg-info";const a=document.createElement("div");a.className="svg-source",a.textContent=e.source;const o=document.createElement("div");o.className="svg-size",o.textContent=`${oe(e.fileSize)} • ${e.dimensions.width}×${e.dimensions.height}`,i.appendChild(a),i.appendChild(o);const u=document.createElement("div");u.className="svg-actions";const f=document.createElement("button");f.className="btn btn-secondary copy-btn",f.title="Copy SVG",f.textContent="Copy";const w=document.createElement("button");w.className="btn btn-secondary download-btn",w.title="Download",w.textContent="Download",u.appendChild(f),u.appendChild(w),t.appendChild(n),t.appendChild(i),t.appendChild(u),s.addEventListener("change",C=>{C.stopPropagation(),I(e.id)}),n.addEventListener("click",C=>{C.target.classList.contains("svg-checkbox")||I(e.id)}),f.addEventListener("click",()=>ne(e)),w.addEventListener("click",()=>se(e)),y.appendChild(t)}}function ee(e){const s=new DOMParser().parseFromString(e,"image/svg+xml").documentElement;if(s.removeAttribute("onload"),s.removeAttribute("onerror"),!s.hasAttribute("viewBox")){const i=s.getAttribute("width"),a=s.getAttribute("height");if(i&&a){const o=parseFloat(i)||24,u=parseFloat(a)||24;s.setAttribute("viewBox",`0 0 ${o} ${u}`)}else s.setAttribute("viewBox","0 0 24 24")}return s.removeAttribute("width"),s.removeAttribute("height"),s.style.width="100%",s.style.height="100%",s}function I(e){d.has(e)?d.delete(e):d.add(e),A(),E()}function te(){S.checked?r.forEach(e=>d.add(e.id)):d.clear(),A(),E()}function A(){const e=d.size;j.textContent=e>0?`(${e} selected)`:"",G.disabled=e===0,S.checked=e===r.length&&e>0,S.indeterminate=e>0&&e<r.length}function N(e){v=e,z(),$({viewMode:e}),E()}function z(){P.classList.toggle("active",v==="grid"),V.classList.toggle("active",v==="list")}async function ne(e){try{await navigator.clipboard.writeText(e.content),ce("Copied to clipboard")}catch(t){console.error("Copy failed:",t)}}async function se(e){const t=O();t.type==="svg"?await l.runtime.sendMessage({type:"DOWNLOAD_SVG",item:e,pageTitle:g}):await l.runtime.sendMessage({type:"DOWNLOAD_PNG",item:e,scale:t.scale,pageTitle:g})}async function ie(){const e=r.filter(t=>d.has(t.id));e.length!==0&&await _(e)}async function ae(){r.length!==0&&await _(r)}async function _(e){const t=O();e.length===1?t.type==="svg"?await l.runtime.sendMessage({type:"DOWNLOAD_SVG",item:e[0],pageTitle:g}):await l.runtime.sendMessage({type:"DOWNLOAD_PNG",item:e[0],scale:t.scale,pageTitle:g}):t.type==="svg"?await l.runtime.sendMessage({type:"DOWNLOAD_ZIP",items:e,pageTitle:g}):await l.runtime.sendMessage({type:"DOWNLOAD_ZIP",items:e,includePng:!0,pngScale:t.scale,pageTitle:g})}function oe(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}function ce(e){const t=document.createElement("div");t.style.cssText=`
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    z-index: 1000;
  `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}q();
